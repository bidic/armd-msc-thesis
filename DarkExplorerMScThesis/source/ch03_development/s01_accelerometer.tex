\section{Akcelerometr trójosiowy}
\label{sec:accelometer}
W latach 90 akcelerometry instalowano jedynie w roli mechanizmów służących do~uruchamiania poduszek powietrznych w samochodzie w przypadku wystąpienia
zderzenia. W chwili obecnej akcelerometry wykonane w technologii
MEMS można znaleźć w~większości urządzeń codziennego użytku tj.
telefony komórkowe, konsole do gier, komputery przenośne czy cyfrowe aparaty
fotograficzne. Powodem tak spektakularnego wzrostu popularności było pełne
rozwinięcie się technologii MEMS. W dobie miniaturyzacji fakt, iż w miejsce do
niedawna używanych urządzeń można wstawić pojedynczy układ
scalony jest jednym z podstawowych powodów dla których, między innymi,
akcelerometry cieszą się tak szerokim spektrum zastosowań. Jednakże, ceną tak
daleko idącej miniaturyzacji jest spadek duży dokładności pomiarowej w
porównaniu do akcelerometrów opartych o~tensometry. Jak się jednak okazuje, do
codziennego użytku precyzja oferowana przez tego typu czujniki jest w zupełności wystarczająca.

Bardzo dobrym przykładem zastosowania akcelerometru jest dostępna w większości
aparatów cyfrowych funkcja optycznej stabilizacji obrazu (Optical Image
Stabilization). Funkcja ta polega na redukcji zniekształceń  spowodowanych
drżeniem rąk fotografa w~trakcie akwizycji obrazu. Problem jest tym poważniejszy
iż nieustanna miniaturyzacja tego typu urządzeń dodatkowo wzmacnia zakłócenia
związane z mimowolnym\footnote{Ręka przeciętnego człowieka drży mimowolnie z
częstotliwością od 10 do 20 Hz} drżeniem rąk użytkownika. Dlatego też większość
aparatów wyposażonych jest w~czujniki które mierzą wspomniane drgania, a następnie uzyskane informacje przekazują do modułu
sterującego położeniem soczewek i przetwornika obrazu. Następnie moduł ten
dostosowuje parametry pracy aparatu tak aby zminimalizować wpływ niepożądanych
przesunięć na~efekt końcowy pracy jakim jest zdjęcie.

Innym popularnym przykładem zastosowania akcelerometrów są pedometry, potocznie 
nazywane krokomierzami. Dzięki zastosowanej technologii czujniki w krokomierzach
mogą dokonywać równocześnie pomiaru względem trzech osi. Co więcej tego typu
urządzenia umożliwiają dokonywanie pomiarów niemal całkowicie niezależne od
swojej orientacji, a ich niewielkie rozmiary pozwalają na ich integrację z 
dowolnymi urządzeniami mobilnymi. Akcelerometry wykonane w technologi MEMS
najlepiej sprawdzają się  podczas pomiaru przyspieszenia statycznego
pozwalającego jednoznacznie wyznaczyć kąt odchylenia urządzenia względem pionu. 
Można nimi dokonywać również pomiaru przyspieszenia dynamicznego pojawiającego 
się na skutek wibracji, uderzenia czy innego rodzaju ruchu. 

Niestety, pomimo swoich licznych zalet akcelerometry MEMS posiadają pewne
ograniczenia które mogą być bardzo istotne podczas projektowania bardziej
skomplikowanych systemów. Jedynym z podstawowych problemów jest brak możliwości
uzyskania jednoznacznej informacji na temat orientacji urządzenia zarówno w
pionie jak i poziomie. W~ramach przykładu spróbujmy przeanalizować wykorzystanie
akcelerometru do przełączania widoku na ekranie w zależności od jego orientacji. 
W~przypadku gdy oś X lub Y są równoległe z wektorem grawitacji na podstawie
informacji z akcelerometru można w~bardzo prosty sposób ustalić w~jakim
położeniu znajduje się aktualnie urządzenie (rys.~\ref{fig:AkcelerometrOrientation}).
\begin{figure}[ht!]
 \centering
 \includegraphics[width=\textwidth]{../images/ch04/acc_orientation.png}
 \caption{Pokrywanie się osi ekranu z kierunkiem wektora grawitacji pozwala na
 precyzyjne wyznaczenie orientacji urządzenia\cite{website:elektronikab2b-zyroskop}}
 \label{fig:AkcelerometrOrientation}
\end{figure}

Natomiast w przypadku gdy osie ekranu ustawią się prostopadle do wektora
grawitacji dane pozyskane z akcelerometru nie pozwalają na wyznaczenie
jednoznacznej pozycji w~jakiej znalazło się urządzenie\cite{website:elektronikab2b-zyroskop}. Co więcej w
przypadku aplikacji w których akcelerometr jest źródłem informacji o odchyleniu
od pionu, konieczne jest rozdzielenie zmian związanych z~wpływem grawitacji od szumów
związanych z przyspieszeniem dynamicznym. Tak pozyskane informacje będą
służyć jako punkt odniesienia pozwalającego na wyznaczenie kąta wychylenia.
Głównym problemem jest fakt, że sygnał taki można wyróżnić jedynie w chwili gdy
akcelerometr jest w stanie spoczynku, co w przypadku niektórych rodzajów
zastosowań może dawać nieoczekiwane rezultaty i zachwiać stabilność pracy całego
systemu. 

Jeżeli założymy, że zmiany odpowiadające przyspieszeniu dynamicznemu mają dużą
częstotliwość to możemy przy użyciu filtru dolnoprzepustowego usunąć zakłócenia
związane z drganiami wywołanymi przez użytkownika. Oczywistą implikacją
powyższego założenia jest założenie, że zmiany kąta nachylenia względem pionu są
wolne gdyż w przeciwnym wypadku informacje o zmianie odchylenia zostaną
usunięte przez wspomniany filtr. Aby~pominięcie wspomnianych ograniczeń stało się możliwe
konieczne jest zastosowanie dodatkowych czujników takich jak np. żyroskop które
dostarczą uzupełniających informacji pozwalających na stabilną implementację
funkcjonalności.
\subsection{Rodzaje akcelerometrów}
Istnieje wiele różnych rodzajów akcelerometrów. Akcelerometry mechaniczne
przypominają po części zachowanie pasażera w samochodzie który gwałtowanie
przyspiesza i zwalnia. Posiadają one element masy przyczepiony do elementu
sprężynowego umieszczonego w całości w zewnętrznej obudowie. Kiedy taki
akcelerometr zacznie przyspieszać obudowa zewnętrzna przemieści się podczas gdy
punkt masy wychyli się w kierunku przeciwnym do przyspieszenia co spowoduje
rozciągnięcie się sprężyny wprost proporcjonalne do siły która spowodowała
przyspieszenie. Mierząc więc odległość na jaką nastąpiło wychylenie jesteśmy w
stanie wyznaczyć wartość działającej siły, a co za tym idzie również wartość
przyspieszenia. Opisana powyżej zasada pomiaru leży u podstaw działania
sejsmografów które za pomocą masy dołączonej do elementu piśmiennego rejestrują
siły występujące w chwili trzęsienia ziemi.

Alternatywnym podejściem jest wykorzystanie sygnałów elektrycznych i
magnetycznych do pomiaru przyspieszenia. Wśród tego rodzaju akcelerometrów
możemy wyróżnić następujące trzy typy: akcelerometr piezorezystywny,
akcelerometr pojemnościowy oraz akcelerometr piezoelektryczny. Istnieją również
akcelerometry które dokonują pomiaru przyspieszenia w oparciu o efekt Halla. 

Przyspieszeniomierze piezorezystywne mają punkt masy dołączony do potencjometru
który zwiększa i zmniejsza przepływ prądu w zależności od siły jaka oddziałuje
na~czujnik. Bardzo podobną zasadą działania charakteryzują się akcelerometry
pojemnościowe, te jednak wykorzystują efekt zmiany pojemności kondensatorów
zastosowanych w~miejscu w którym poprzednio użyty został potencjometr. Schemat
ideowy jednoosiowego akcelerometru pojemnościowego widoczny jest na rysunku
\ref{fig:AkcelerometrIdeowyScheamt}.
\newpage
\begin{figure}[h!]
 \centering
 \includegraphics[height=65mm]{../images/ch04/acc_intro.png}
 \caption{Schemat ideowy akcelerometru pojemnościowego dokonującego pomiaru
 wzdłuż jednej osi\cite{ElektronikaPraktyczna22010}}
 \label{fig:AkcelerometrIdeowyScheamt}
\end{figure} 
Ostatnim rodzajem akcelerometrów są urządzeniami bazujące na piezoelektrycznych kryształach takich jak na przykład kwarc. W urządzeniach tych punkt masy, pod~wpływem
przyspieszenia, naciska na kryształ co powoduje, powstawanie napięcia które
jest wykorzystywane do wykonywania pomiaru. Cechą charakterystyczną tego rodzaju
czujników jest brak wskazań wartości przyspieszenia
statycznego\cite{website:elektronikab2b-platforma-bezzalogowa}.
\subsection{Algorytm rozpoznawania kroków}
Do poprawnego działania algorytmu zaprezentowanego w ramach noty
aplikacyjnej\cite{Pedometer-haam326b} wymagane jest wykorzystanie akcelerometru
trójosiowego. Jak już wspomniano wcześniej, dzięki zastosowaniu urządzenia tego
typu jesteśmy w stanie wyeliminować problemy wynikające z konieczności 
uwzględnienia aktualnego wychylenia akcelerometru względem wektora grawitacji. 
W przypadku gdyby możliwe byłoby korzystanie tylko z pojedynczych osi poprawne
działanie algorytmu byłoby zapewnione jedynie w ściśle określonej pozycji co
jest znaczącym utrudnieniem biorąc pod uwagę niehomogeniczny charakter ruchów
wykonywanych podczas chodzenia. Aby wyeliminować wspomniany problem do
ostatecznego rozwiązania brana jest jedynie wartość stanowiąca złożenie wartości
przyspieszenia dla poszczególnych osi. Do wyznaczenia bezwzględnego
przyspieszenia na~podstawie danych z osi X, Y, Z użyte zostało równanie
\ref{eq:AccCompositEq}.
\begin{equation}
a_{xyz} = \sqrt{{a_x}^2 + {a_y}^2 + {a_z}^2}
\label{eq:AccCompositEq}
\end{equation}
Zaimplementowany w ramach pracy magisterskiej algorytm wykrywania i zliczania
kroków bazuje na założeniu iż sumaryczna wartość przyspieszenia wykrywanego
przez akcelerometr w trakcie chodzenia oscyluje wokół wartości 1G\footnote{1G
- Jednokrotność przyspieszenia ziemskiego wynoszącego w przybliżeniu 9.81
$\frac{m}{s^2}$}. Podstawową zasadą działania algorytmu jest więc wykrywanie
cykli w jakich następuje kolejno spadek wartości odczytywanego przyspieszenia, a
następnie jego wzrost ponad wartość spoczynkową. Do~poprawnego działania
algorytmu konieczne jest dobranie nie tylko odpowiedniej stałej czasowej w
której wykryty cykl będzie zliczany jako krok, ale również ustalenie progów
przyspieszenia poniżej i powyżej wartości spoczynkowej które będą traktowane
jako odpowiednio początek i koniec cyklu.
\subsection{Implementacja algorytmu}
Do praktycznej implementacji algorytmu wykrywania kroków wykorzystany został
moduł akcelerometru trójosiowego firmy Freescale Semiconductor. Czujnik 
MMA7260\cite{MMA7260DataSheet} został zainstalowany w robocie jako element
modułu MOBOT-GM3A (rys. \ref{fig:AccView}). Moduł akcelerometru jest to jedyny moduł
w całości dostarczony przez zewnętrznego dostawcę, a wybór takiej strategii podyktowany
był jedynie względami ekonomicznymi i dostępnością tego typu urządzeń na polskim
rynku elektronicznym. Na ilustracji zamieszczone zostało zdjęcie gotowego układu
wraz z zaznaczonymi wyprowadzeniami które zostały wykorzystane w ramach pracy
magisterskiej.

\begin{figure}[ht!]
 \centering
 \includegraphics[width=\textwidth]{../images/ch04/gm3a_view.png}
 \caption{Moduł akcelerometru trójosiowego z czujnikiem przyspieszenia MMA7260}
 \label{fig:AccView}
\end{figure}
\newpage
Wykorzystany czujnik przyspieszenia oferuje cztery zakresy czułości których
zmiana odbywa się poprzez konfigurację odpowiednich zworek w module MOBOT -
GM3A. W~ramach implementacji wybrany został zakres czułości od $-1.5g$ do $1.5g$ gdyż
udziela on najdokładniejszej informacji na temat przyspieszenia w przedziale w
jakim mieszczą się przyspieszenia związane z chodzeniem. W wybranym trybie
czułości akcelerometr wykazuje czułość rzędu 800mV/g, co przy wartości
przyspieszenia równej zero daje środek przedziału czułości na poziomie 1.65V.
Ze względu na analogową charakterystykę sygnału wyjściowego z modułu
akcelerometru konieczne jest wykorzystanie konwertera analogowo-cyfrowego w
celu odczytania danych pomiarowych otrzymywanych na wyjściach urządzenia.
Szczegółowy opis działania wbudowanego w robot ADC\footnote{Analog to Digital
Converter} można znaleźć w rozdziale poświęconym dalmierzom IR. 

\begin{figure}[ht!]
 \centering
 \includegraphics[width=\textwidth]{../images/ch04/mma7260_datasheet.png}
 \caption{Wartości przyspieszenia statycznego dla układu MMA7260 dostarczone w~ramach specyfikacji technicznej urządzenia\cite{MMA7260DataSheet}}
 \label{fig:MMADataSheetStaticAcc}
\end{figure}

Przed rozpoczęciem praktycznej implementacji algorytmu wykrywania kroków
konieczne okazało się przeprowadzenie kalibracji modułu, gdyż już wstępne testy
czujnika zwróciły spore różnice pomiędzy wartościami podanymi w nocie
katalogowej, a stanem zmierzonym na wyjściach akcelerometru. Zgodnie z rysunkiem
\ref{fig:MMADataSheetStaticAcc} znalezionym w dokumentacji udostępnionej przez producenta czułość
oraz zakres napięć na poszczególnych osiach powinien być w stałych, jednakowych
przedziałach. Niestety, jak się okazało, poszczególne osie miały bardzo
znaczące różnice w zakresie swojej czułości co mogłoby bardzo niekorzystnie wpłynąć na
stabilność działania zaproponowanego algorytmu zliczania kroków. 

Wspomniany proces kalibracji polegał na ustawieniu czujnika na płaskiej,
poziomej powierzchni oraz odczytaniu wartości przyspieszenia statycznego dla
każdej z osi z~osobna. Procedurę taką powtarzano wielokrotnie zmieniając
orientację modułu względem wektora grawitacji. Po zebraniu wszystkich danych
pomiarowych dla każdej osi z osobna, została wyznaczona rzeczywista czułość, a
następnie w module odpowiedzialnym za akwizycję danych o przyspieszeniu zostały
zaprogramowane funkcje korygujące otrzymane dane wejściowe o wartości wyliczone
podczas kalibracji urządzenia.

Na wykresach \ref{fig:MMADataRaw} oraz \ref{fig:MMADataCalib} znajdują się
informacje o stanie wyjść przed i po przeprowadzeniu kalibracji. Wykresy
przedstawiają przyspieszenie statyczne jakie ustaliło się na poszczególnych
osiach akcelerometru w stanie spoczynku jak również zmianę tego przyspieszenia w
chwili ustalania nowej orientacji czujnika. Wartość przyspieszenia statycznego
została wyznaczona na podstawie napięcia odczytanego za pomocą konwertera ADC z
odpowiednich wyjść akcelerometru. Jak można wnioskować na podstawie rysunku
\ref{fig:MMADataSheetStaticAcc} oraz wartości przyspieszeń na osiach X, Y, Z
prezentowanych na wykresach \ref{fig:MMADataRaw}, \ref{fig:MMADataCalib} w~chwili
czasowej 0 akcelerometr był ustawiony bokiem z a zwrot  i kierunek osi X był
zgody z~kierunkiem wektora grawitacji. W chwili czasowej 400 rozpoczyna się obrót
akcelerometru o $90\,^{\circ}$ wokół osi Y, aż do ustalenia się nowej orientacji
czujnika w chwili czasowej 600. Oczekiwaną wartością wypadkową przyspieszeń na
poszczególnych osiach w chwili gdy akcelerometr znajduje się w stanie spoczynku
jest wartość przyspiesznia w przybliżeniu równą 1000 mg, podczas gdy wartości
przed kalibracją, widoczne na wykresie \ref{fig:MMADataRaw}, w pierwszej pozycji
ustalonej dają przyspieszenie wypadkowe rzędu 700 mg natomiast w drugiej pozycji
ustalonej -1300 mg. Jak można zaobserwować rozbieżności pomiędzy odczytami bez i
z kalibracją są dosyć znaczące, a dla rozważanego sposobu zastosowania wręcz
krytyczne. Dlatego też istotne jest aby przed uruchomieniem algorytmu
rozpoznawania kroków mieć pewność, że czujnik jest w prawidłowy sposób
skalibrowany. \newpage
  
\begin{figure}[h!]
 \centering \includegraphics[width=\textwidth]{../images/ch04/raw_acc_data.png}
 \caption{Wartości przyspieszenia odczytywane na wyjściach akcelerometru przed
 przeprowadzeniem kalibracji}
 \label{fig:MMADataRaw}
\end{figure}
  
\begin{figure}[h!]
 \centering \includegraphics[width=\textwidth]{../images/ch04/calib_acc_data.png}
 \caption{Wartości odczytywane na wyjściach akcelerometru po przeprowadzeniu kalibracji}
 \label{fig:MMADataCalib}
\end{figure}